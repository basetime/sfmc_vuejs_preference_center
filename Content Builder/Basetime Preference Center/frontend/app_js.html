new Vue({
  el: '#app',
  vuetify: new Vuetify(),
  data () { 
    return {
      authorized: isAuthorized === 1 ? true : false,
      darkMode: false,
      debug: true,
      applicationConfiguration,
      preferenceOptions,
      channelSelection,
      formSubmitting: false,
      subscriber: {
        subscriberId: subscriberId,
        subscriberKey: subscriberKey,
        emailAddress: emailAddress,
        jobId: jobId,
        preferences: []
      }
    }
  },
  mounted () {
    this.debug && this.debugData();
    this.getExistingPreferences();
  },
  methods: {
    debugData() {
      console.log({
        config: this.applicationConfiguration,
        preferenceOptions: this.preferenceOptions
      })
    },
    getDefaultChannelSelection(){
      const channels = Object.keys(this.preferenceOptions.channels);
      this.channelSelection = channels[0];
    },
    async getExistingPreferences(){
      try {
        const subscriberId = this.subscriber.subscriberId;
        const submitRequest = await axios.post(`${this.apiBaseURL}getCurrentPreferences`, {
          subscriberId
        })

        console.log(submitRequest)

        if(submitRequest.data.Status === 'OK'){
          this.subscriber.preferences = submitRequest.data.Results;
        } 

      } catch (err) {
        console.log(err)
      }
    },
    onUpdateDarkMode() {
      this.darkMode = !this.darkMode
    },
    onUpdateChannelSelection($event) {
      this.channelSelection = $event
    },
    async onSubmitPreferenceForm($event) {
      try {
        let postData = {
          updatedInfo: []
        };
        
        if(Object.prototype.hasOwnProperty.call($event, 'profile')){
          const profileData = $event.profile;
          for(const pro in profileData){
            postData.updatedInfo.push({
              Name: pro,
              Value: profileData[pro]
            })
          }
        }

        if(Object.prototype.hasOwnProperty.call($event, 'preferences')){
          const preferenceData = $event.preferences;
          for(const pre in preferenceData){
            postData.updatedInfo.push({
              Name: pre,
              Value: preferenceData[pre]
            })
          }
        }
     
        if(Object.prototype.hasOwnProperty.call($event, 'subscriptions')){
          const subscriptionData = $event.subscriptions.subscriptions;
          let subscriptions = ''

          for(const sub of subscriptionData){
           subscriptions += `${sub}|`
          }

          subscriptions = subscriptions.substring(0, subscriptions.length - 1)

          postData.updatedInfo.push({
            Name: 'subscriptions',
            Value: subscriptions
          })
        }

        postData.updatedInfo.push({
          Name: 'subscriberId',
          Value: this.subscriber.subscriberId
        },
        {
          Name: 'emailAddress',
          Value: this.subscriber.emailAddress
        },
        {
          Name: 'channel',
          Value: this.channelSelection
        })


        const submitRequest = await axios.post(`${this.apiBaseURL}submitPreferenceForm`, {
          postData
        })
        
        console.log(submitRequest)

      } catch (err) {
        console.log(err)
      }
    }
  },
  computed: {
    apiBaseURL(){
      return `${this.applicationConfiguration.apiBaseURL}?action=`
    },
    branding(){
      if(this.applicationConfiguration.branding.supportDarkMode && this.darkMode){
        return this.applicationConfiguration.branding.dark
      }

      return this.applicationConfiguration.branding.default
    }
  }
})